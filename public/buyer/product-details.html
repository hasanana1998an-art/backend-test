<!DOCTYPE html>
<html lang="ar" dir="rtl">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>تفاصيل المنتج | متجر الطاقة الذكية</title>
        <link rel="stylesheet" href="../css/reset.css">
        <link rel="stylesheet" href="../css/style.css">
        <link rel="stylesheet" href="../css/responsive.css">
        <style>
            .product-details-container {
                max-width: 1200px;
                margin: 30px auto;
                display: flex;
                flex-wrap: wrap;
                gap: 20px;
                background: #fff;
                padding: 20px;
                border-radius: 12px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .product-details-container img {
                width: 350px;
                height: 350px;
                object-fit: cover;
                border-radius: 12px;
            }

            .product-info {
                flex: 1;
            }

            .product-info h2 {
                font-size: 1.8rem;
                margin-bottom: 10px;
            }

            .product-info p {
                margin-bottom: 10px;
                color: #555;
            }

            .product-info .price {
                font-size: 1.5rem;
                color: #ff8c00;
                margin-bottom: 15px;
            }

            .btn-add-cart {
                background-color: #ff8c00;
                color: #fff;
                padding: 10px 20px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: bold;
                transition: 0.3s;
            }

            .btn-add-cart:hover {
                background-color: #e67600;
            }

            .related-products {
                max-width: 1200px;
                margin: 30px auto;
            }

            .related-products h3 {
                margin-bottom: 15px;
            }

            .products-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
                gap: 20px;
            }

            .product-card {
                background: #fff;
                padding: 15px;
                border-radius: 12px;
                text-align: center;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            .product-card img {
                width: 100%;
                height: 220px;
                object-fit: cover;
                border-radius: 8px;
            }

            .product-card h4 {
                margin: 10px 0;
                font-size: 1.1rem;
            }

            .product-card .price {
                font-size: 1rem;
                color: #ff8c00;
                margin-bottom: 10px;
            }

            .product-card .btn {
                display: inline-block;
                padding: 8px 15px;
                background-color: #007bff;
                color: #fff;
                border-radius: 6px;
                text-decoration: none;
                font-weight: bold;
            }

            .product-card .btn:hover {
                background-color: #0056b3;
            }
        </style>
    </head>

    <body>
        <!-- ===== الهيدر ===== -->
        <header class="main-header">
            <div class="container">
                <div class="logo">
                    <img src="../images/logo.png" alt="شعار المتجر">
                    <span>متجر الطاقة الذكية</span>
                </div>

                <nav class="nav-menu">
                    <a href="index.html">الرئيسية</a>
                    <a href="products.html" class="active">المنتجات</a>
                    <a href="profile.html">الملف الشخصي</a>
                    <a href="orders.html">طلباتي</a>
                    <a href="cart.html">السلة</a>
                </nav>

                <div class="auth-buttons">
                    <span id="user-name" style="margin-right:10px;font-weight:bold;"></span>
                    <button id="logout-btn" class="btn-logout">تسجيل الخروج</button>
                </div>
            </div>
        </header>

        <!-- ===== تفاصيل المنتج ===== -->
        <section class="product-details-container" id="product-details">
            <img id="product-image" src="../images/default_product.png" alt="صورة المنتج">
            <div class="product-info">
                <h2 id="product-name">اسم المنتج</h2>
                <p id="product-description">وصف تفصيلي للمنتج.</p>
                <div class="price" id="product-price">0.00 $</div>
                <button class="btn-add-cart" id="add-to-cart">إضافة إلى السلة</button>
            </div>
        </section>

        <!-- ===== منتجات مشابهة ===== -->
        <section class="related-products">
            <h3>منتجات مشابهة</h3>
            <div class="products-grid" id="similar-products"></div>
        </section>

        <!-- ===== الفوتر ===== -->
        <footer class="main-footer">
            <div class="container footer-container">
                <div class="footer-section">
                    <h4>عن المتجر</h4>
                    <p>متجر متخصص في بيع المنتجات الكهربائية وحلول الطاقة البديلة بجودة عالية وأسعار منافسة.</p>
                </div>
                <div class="footer-section">
                    <h4>روابط سريعة</h4>
                    <ul>
                        <li><a href="index.html">الرئيسية</a></li>
                        <li><a href="products.html">المنتجات</a></li>
                        <li><a href="profile.html">الملف الشخصي</a></li>
                        <li><a href="cart.html">السلة</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>تواصل معنا</h4>
                    <p>البريد: info@smartenergy.com</p>
                    <p>الهاتف: +963 999 999 999</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>© 2025 جميع الحقوق محفوظة - متجر الطاقة الذكية</p>
            </div>
        </footer>

        <script>
            const API_BASE = "https://backend-test-production-196e.up.railway.app";
            const accessToken = localStorage.getItem('access_token');
            const user = JSON.parse(localStorage.getItem('user') || 'null');

            if (!accessToken || !user) window.location.href = "../common/login.html";
            else document.getElementById('user-name').textContent = "مرحباً بك، " + user.name;

            document.getElementById('logout-btn').addEventListener('click', () =>
            {
                localStorage.removeItem('access_token');
                localStorage.removeItem('user');
                window.location.href = "../common/login.html";
            });

            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get("id");

            async function fetchProductDetails()
            {
                try
                {
                    // جلب بيانات المنتج
                    const res = await fetch(`${API_BASE}/api/products/${productId}`, {
                        headers: { "Authorization": "Bearer " + accessToken }
                    });
                    const product = await res.json();

                    // عرض بيانات المنتج
                    const imgSrc = product.image_url ? `${API_BASE}/${product.image_url}` : '../images/default_product.png';
                    document.getElementById("product-image").src = imgSrc;
                    document.getElementById("product-name").textContent = product.name;
                    document.getElementById("product-description").textContent = product.description;
                    document.getElementById("product-price").textContent = parseFloat(product.price).toFixed(2) + " $";

                    // زر إضافة للسلة
                    document.getElementById("add-to-cart").addEventListener("click", async () =>
                    {
                        try
                        {
                            const res = await fetch(`${API_BASE}/api/cart`, {
                                method: "POST",
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': 'Bearer ' + accessToken
                                },
                                body: JSON.stringify({ product_id: product.id, quantity: 1 })
                            });
                            if (!res.ok) throw new Error("فشل الإضافة للسلة");
                            alert("تمت إضافة المنتج إلى السلة ✅");
                        } catch (err)
                        {
                            console.error(err);
                            alert("تعذر إضافة المنتج للسلة ❌");
                        }
                    });

                    // جلب المنتجات المشابهة
                    const similarRes = await fetch(`${API_BASE}/api/products?category_id=${product.category_id}`, {
                        headers: { "Authorization": "Bearer " + accessToken }
                    });
                    const products = await similarRes.json();
                    const container = document.getElementById("similar-products");
                    container.innerHTML = "";
                    products.filter(p => p.id != product.id).forEach(p =>
                    {
                        const productImg = p.image_url ? `${API_BASE}/${p.image_url}` : '../images/default_product.png';
                        container.innerHTML += `
                        <div class="product-card">
                            <img src="${productImg}" alt="${p.name}">
                            <h4>${p.name}</h4>
                            <p class="price">${parseFloat(p.price).toFixed(2)} $</p>
                            <a href="product-details.html?id=${p.id}" class="btn">عرض التفاصيل</a>
                        </div>
                    `;
                    });

                } catch (err)
                {
                    console.error(err);
                    alert("فشل جلب بيانات المنتج");
                }
            }

            fetchProductDetails();
        </script>
    </body>

</html>
