<!DOCTYPE html>
<html lang="ar" dir="rtl">

    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>لوحة البائع | إدارة المنتجات</title>
        <link rel="stylesheet" href="../css/reset.css">
        <link rel="stylesheet" href="../css/responsive.css">
        <link rel="stylesheet" href="../css/style.css">
        <style>
            body {
                font-family: "Cairo", sans-serif;
                background: #f5f5f5;
                margin: 0;
                color: #333
            }

            .container {
                max-width: 1200px;
                margin: auto;
                padding: 20px
            }

            .main-header {
                background: #1e5631;
                color: #fff;
                padding: 10px 0;
                position: sticky;
                top: 0;
                z-index: 1000
            }

            .main-header .container {
                display: flex;
                justify-content: space-between;
                align-items: center
            }

            .main-header h1 {
                margin: 0;
                font-size: 1.5rem
            }

            .nav-menu a {
                margin: 0 10px;
                color: #fff;
                font-weight: bold;
                text-decoration: none;
                transition: .3s
            }

            .nav-menu a:hover {
                color: #ffb400
            }

            .btn-logout {
                background: #dc3545;
                color: #fff;
                border: none;
                padding: 8px 12px;
                border-radius: 5px;
                cursor: pointer
            }

            .notice {
                background: #fff3cd;
                color: #7a5d00;
                border: 1px solid #ffe69c;
                padding: 12px 14px;
                border-radius: 8px;
                margin-top: 16px;
                display: none
            }

            .error {
                background: #fde2e1;
                color: #7f1d1d;
                border: 1px solid #f8b4b4
            }

            .products-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                gap: 20px;
                margin-top: 20px
            }

            .product-card {
                background: #fff;
                border-radius: 12px;
                padding: 15px;
                text-align: center;
                box-shadow: 0 2px 8px rgba(0, 0, 0, .1);
                transition: .3s;
                position: relative
            }

            .product-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 5px 15px rgba(0, 0, 0, .2)
            }

            .product-card img {
                width: 120px;
                height: 120px;
                object-fit: contain;
                margin-bottom: 10px
            }

            .product-card h3 {
                margin: 5px 0;
                font-size: 1rem
            }

            .product-card p {
                font-size: .85rem;
                color: #555;
                margin: 3px 0
            }

            .meta {
                font-size: .8rem;
                color: #777
            }

            .btn {
                padding: 6px 10px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                margin: 3px
            }

            .btn-edit {
                background: #ffc107;
                color: #000
            }

            .btn-delete {
                background: #dc3545;
                color: #fff
            }

            .btn-add {
                background: #ffb400;
                color: #000;
                margin-bottom: 20px
            }

            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, .5);
                justify-content: center;
                align-items: center;
                padding: 12px
            }

            .modal-content {
                background: #fff;
                padding: 20px;
                border-radius: 12px;
                width: 100%;
                max-width: 480px
            }

            .modal-content input,
            .modal-content select,
            .modal-content textarea {
                width: 100%;
                padding: 10px;
                margin: 6px 0;
                border: 1px solid #ddd;
                border-radius: 8px
            }

            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 8px
            }

            .close-btn {
                cursor: pointer;
                font-size: 1.2rem;
                font-weight: bold
            }

            .form-row {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px
            }

            .empty {
                background: #fff;
                border: 1px dashed #ddd;
                border-radius: 12px;
                padding: 30px;
                text-align: center;
                color: #777;
                margin-top: 16px
            }

            @media (max-width:768px) {
                .nav-menu {
                    display: none
                }
            }
        </style>
    </head>

    <body>
        <header class="main-header">
            <div class="container">
                <div class="logo" style="display:flex;gap:10px;align-items:center">
                    <img src="../images/logo.png" alt="Logo" style="height:36px" />
                    <h1>لوحة البائع</h1>
                </div>
                <nav class="nav-menu">
                    <a href="seller_dashboard.html" class="active">المنتجات</a>
                    <a href="seller_orders.html">الطلبات</a>
                    <a href="seller_stats.html">الإحصائيات</a>
                    <a href="seller_profile.html">الحساب</a>
                </nav>
                <button class="btn-logout" onclick="logout()">تسجيل الخروج</button>
            </div>
        </header>

        <div class="container">
            <button class="btn btn-add" id="addProductBtn">إضافة منتج جديد</button>
            <div id="notice" class="notice"></div>
            <div id="errorBox" class="notice error"></div>
            <div class="products-grid" id="productsGrid"></div>
            <div id="emptyBox" class="empty" style="display:none">لا توجد منتجات حتى الآن. اضغط "إضافة منتج جديد" لبدء
                الإضافة.</div>
        </div>

        <!-- نموذج الإضافة/التعديل -->
        <div class="modal" id="productModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTitle">إضافة منتج</h3>
                    <span class="close-btn" id="closeModal">&times;</span>
                </div>
                <input type="hidden" id="productId">
                <label>اسم المنتج</label>
                <input type="text" id="productName" placeholder="اسم المنتج" />
                <label>وصف المنتج</label>
                <textarea id="productDescription" rows="3" placeholder="وصف المنتج"></textarea>
                <div class="form-row">
                    <div>
                        <label>السعر</label>
                        <input type="number" id="productPrice" step="0.01" placeholder="السعر" />
                    </div>
                    <div>
                        <label>الكمية</label>
                        <input type="number" id="productStock" placeholder="الكمية" />
                    </div>
                </div>
                <label>رابط صورة المنتج</label>
                <input type="text" id="productImage" placeholder="مثال: https://... أو path داخل storage" />
                <label>الفئة</label>
                <select id="productCategory">
                    <option value="">اختر الفئة</option>
                </select>
                <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
                    <button class="btn" id="cancelBtn">إلغاء</button>
                    <button class="btn btn-add" id="saveProductBtn">حفظ المنتج</button>
                </div>
            </div>
        </div>

        <footer class="main-footer">
            <div class="footer-container">
                <div class="footer-section">
                    <h4>روابط البائع</h4>
                    <ul>
                        <li><a href="seller_dashboard.html">المنتجات</a></li>
                        <li><a href="seller_orders.html">الطلبات</a></li>
                        <li><a href="seller_stats.html">الإحصائيات</a></li>
                        <li><a href="seller_profile.html">الحساب</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>الدعم والمساعدة</h4>
                    <ul>
                        <li><a href="../contact.html">اتصل بنا</a></li>
                        <li><a href="../terms.html">الشروط والأحكام</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>الموقع</h4>
                    <p>متجر الطاقة الذكية © 2025</p>
                    <p>جميع الحقوق محفوظة</p>
                </div>
            </div>
            <div class="footer-bottom">تم تطوير المنصة بواسطة فريق التقنية</div>
        </footer>

        <script>
            const API_BASE = "http://127.0.0.1:8000/api";
            const SITE_BASE = API_BASE.replace(/\/api\/?$/, ""); // http://127.0.0.1:8000
            const accessToken = localStorage.getItem('access_token');
            if (!accessToken) window.location.href = '../common/login.html';

            const productsGrid = document.getElementById('productsGrid');
            const productModal = document.getElementById('productModal');
            const addProductBtn = document.getElementById('addProductBtn');
            const closeModal = document.getElementById('closeModal');
            const cancelBtn = document.getElementById('cancelBtn');
            const modalTitle = document.getElementById('modalTitle');
            const saveProductBtn = document.getElementById('saveProductBtn');
            const emptyBox = document.getElementById('emptyBox');
            const notice = document.getElementById('notice');
            const errorBox = document.getElementById('errorBox');

            const productId = document.getElementById('productId');
            const productName = document.getElementById('productName');
            const productDescription = document.getElementById('productDescription');
            const productPrice = document.getElementById('productPrice');
            const productStock = document.getElementById('productStock');
            const productImage = document.getElementById('productImage');
            const productCategory = document.getElementById('productCategory');

            const authHeaders = { "Authorization": "Bearer " + accessToken, "Accept": "application/json" };

            let CURRENT_USER = null;
            let PRODUCTS_BY_ID = {};
            let CATEGORIES = [];

            function show(el, flag) { el.style.display = flag ? "" : "none"; }
            function setNotice(msg) { if (!msg) { notice.style.display = "none"; notice.textContent = ""; return; } notice.textContent = msg; notice.style.display = "block"; }
            function setError(msg) { if (!msg) { errorBox.style.display = "none"; errorBox.textContent = ""; return; } errorBox.textContent = msg; errorBox.style.display = "block"; }

            function isAbsoluteUrl(url) { return /^https?:\/\//i.test(url) || url?.startsWith("data:"); }
            function resolveImage(p)
            {
                const raw = p.image_url || p.image || "";
                if (!raw) return "https://via.placeholder.com/120x120?text=No+Image";
                if (isAbsoluteUrl(raw)) return raw;
                // إن كان المسار يبدأ بـ storage/ أو uploads/ أو images/ استخدمه من الجذر
                if (raw.startsWith("storage/") || raw.startsWith("uploads/") || raw.startsWith("images/")) return `${SITE_BASE}/${raw}`;
                // Laravel storage الافتراضي
                return `${SITE_BASE}/storage/${raw}`;
            }

            function toArray(data) { return Array.isArray(data) ? data : (data?.data ?? []); }

            function openModalAdd()
            {
                modalTitle.textContent = "إضافة منتج";
                productModal.style.display = "flex";
                productId.value = "";
                productName.value = "";
                productDescription.value = "";
                productPrice.value = "";
                productStock.value = "";
                productImage.value = "";
                productCategory.value = "";
            }
            function openModalEdit(p)
            {
                modalTitle.textContent = "تعديل المنتج";
                productModal.style.display = "flex";
                productId.value = p.id;
                productName.value = p.name ?? "";
                productDescription.value = p.description ?? p.short_description ?? "";
                productPrice.value = p.price ?? "";
                productStock.value = p.stock_quantity ?? "";
                productImage.value = p.image_url ?? p.image ?? "";
                productCategory.value = p.category_id ?? "";
            }
            function closeModalFn() { productModal.style.display = "none"; }

            function productCardHTML(p)
            {
                const img = resolveImage(p);
                const catName = CATEGORIES.find(c => c.id === p.category_id)?.name ?? "غير محدد";
                return `
          <img src="${img}" alt="${p.name ?? ''}" />
          <h3>${p.name ?? ''}</h3>
          <p class="meta">${catName}</p>
          <p>${p.description ?? ''}</p>
          <p>السعر: ${Number(p.price ?? 0)}</p>
          <p>الكمية: ${parseInt(p.stock_quantity ?? 0)}</p>
          <div>
            <button class="btn btn-edit" data-action="edit" data-id="${p.id}">تعديل</button>
            <button class="btn btn-delete" data-action="delete" data-id="${p.id}">حذف</button>
          </div>
        `;
            }

            function renderProducts(list)
            {
                productsGrid.innerHTML = "";
                PRODUCTS_BY_ID = {};
                if (!list || list.length === 0)
                {
                    show(emptyBox, true);
                    return;
                }
                show(emptyBox, false);
                list.forEach(p =>
                {
                    PRODUCTS_BY_ID[p.id] = p;
                    const card = document.createElement('div');
                    card.className = 'product-card';
                    card.innerHTML = productCardHTML(p);
                    productsGrid.appendChild(card);
                });
            }

            async function fetchUser()
            {
                const res = await fetch(`${API_BASE}/user`, { headers: authHeaders });
                if (!res.ok) throw new Error("فشل جلب بيانات المستخدم");
                CURRENT_USER = await res.json();
            }

            async function fetchCategories()
            {
                const res = await fetch(`${API_BASE}/categories`);
                const data = await res.json();
                CATEGORIES = toArray(data);
                // تعبئة القائمة
                productCategory.innerHTML = '<option value="">اختر الفئة</option>';
                CATEGORIES.forEach(cat =>
                {
                    const option = document.createElement('option');
                    option.value = cat.id;
                    option.textContent = cat.name;
                    productCategory.appendChild(option);
                });
            }

            async function loadProducts()
            {
                setNotice(""); setError("");
                let usedFallback = false;
                let arr = [];
                // المحاولة الأولى: /seller/products
                try
                {
                    const res = await fetch(`${API_BASE}/seller/products`, { headers: authHeaders });
                    if (res.ok)
                    {
                        const data = await res.json();
                        arr = toArray(data);
                    } else
                    {
                        usedFallback = true;
                    }
                } catch (e)
                {
                    usedFallback = true;
                }
                // fallback: /products ثم فلترة بواسطة user_id
                if (usedFallback)
                {
                    try
                    {
                        const resUser = CURRENT_USER ? { ok: true } : await fetch(`${API_BASE}/user`, { headers: authHeaders });
                        if (!CURRENT_USER && resUser.ok) { CURRENT_USER = await resUser.json(); }
                        const res = await fetch(`${API_BASE}/products`, { headers: authHeaders });
                        const data = await res.json();
                        const all = toArray(data);
                        arr = CURRENT_USER ? all.filter(p => p.user_id === CURRENT_USER.id) : all;
                        setNotice("تم استخدام استدعاء احتياطي لعرض منتجاتك. قد لا تظهر المنتجات غير المفعّلة (is_active = false). يُنصح بإضافة مسار GET /seller/products في الـ API.");
                    } catch (e)
                    {
                        setError("تعذّر تحميل المنتجات. تأكد من عمل الخادم والتوكن والصلاحيات.");
                        arr = [];
                    }
                }
                renderProducts(arr);
            }

            async function createOrUpdateProduct()
            {
                setError("");
                const id = productId.value || null;

                // تحقق بسيط
                if (!productName.value || !productPrice.value || !productStock.value || !productCategory.value)
                {
                    setError("الرجاء تعبئة الاسم، السعر، الكمية، والفئة.");
                    return;
                }

                const payload = {
                    name: productName.value,
                    description: productDescription.value || null,
                    price: parseFloat(productPrice.value),
                    stock_quantity: parseInt(productStock.value),
                    category_id: parseInt(productCategory.value),
                    image_url: productImage.value || null,
                    // افتراضياً مفعّل (يمكنك إزالة السطر إن كان لديك قيمة افتراضية في DB)
                    is_active: true
                };

                const method = id ? 'PUT' : 'POST';
                const url = id ? `${API_BASE}/products/${id}` : `${API_BASE}/products`;

                const res = await fetch(url, {
                    method,
                    headers: { ...authHeaders, "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (!res.ok)
                {
                    let msg = "فشل حفظ المنتج.";
                    try { const j = await res.json(); msg += " " + (j.message || ""); } catch { }
                    setError(msg);
                    return;
                }
                closeModalFn();
                await loadProducts();
            }

            async function deleteProduct(id)
            {
                if (!confirm('هل أنت متأكد من حذف هذا المنتج؟')) return;
                setError("");
                const res = await fetch(`${API_BASE}/products/${id}`, {
                    method: 'DELETE',
                    headers: authHeaders
                });
                if (!res.ok)
                {
                    let msg = "فشل حذف المنتج.";
                    try { const j = await res.json(); msg += " " + (j.message || ""); } catch { }
                    setError(msg);
                    return;
                }
                await loadProducts();
            }

            // أحداث
            addProductBtn.addEventListener('click', openModalAdd);
            closeModal.addEventListener('click', closeModalFn);
            cancelBtn.addEventListener('click', closeModalFn);
            productModal.addEventListener('click', (e) => { if (e.target === productModal) closeModalFn(); });
            window.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeModalFn(); });

            productsGrid.addEventListener('click', (e) =>
            {
                const btn = e.target.closest('button[data-action]');
                if (!btn) return;
                const id = parseInt(btn.getAttribute('data-id'));
                const action = btn.getAttribute('data-action');
                if (action === 'edit')
                {
                    const p = PRODUCTS_BY_ID[id];
                    if (p) openModalEdit(p);
                } else if (action === 'delete')
                {
                    deleteProduct(id);
                }
            });

            saveProductBtn.addEventListener('click', createOrUpdateProduct);

            function logout()
            {
                localStorage.removeItem('access_token');
                window.location.href = '../common/login.html';
            }
            window.logout = logout; // للتوافق مع onclick في الهيدر

            // تشغيل
            (async function init()
            {
                try
                {
                    await fetchUser();
                } catch (e)
                {
                    // لو فشل /user لا نوقف كل شيء ولكن سنفقد الفلترة بالمالك في الاستدعاء الاحتياطي
                }
                await fetchCategories();
                await loadProducts();
            })();
        </script>
    </body>

</html>
