<!DOCTYPE html>
<html lang="ar" dir="rtl">

    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>لوحة البائع | إدارة المنتجات</title>
        <link rel="stylesheet" href="../css/reset.css">
        <link rel="stylesheet" href="../css/responsive.css">
        <link rel="stylesheet" href="../css/style.css">
        <style>
            body {
                font-family: Tahoma, sans-serif;
            }

            .container {
                max-width: 1200px;
                margin: auto;
                padding: 20px;
            }

            /* الشبكة */
            .products-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                gap: 20px;
                margin-top: 20px;
            }

            .product-card {
                background: #fff;
                border-radius: 12px;
                padding: 15px;
                text-align: center;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                transition: 0.3s;
            }

            .product-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            }

            .product-card img {
                width: 120px;
                height: 120px;
                object-fit: contain;
                margin-bottom: 10px;
            }

            .product-card h3 {
                margin: 5px 0;
                font-size: 1rem;
            }

            .product-card p {
                font-size: 0.85rem;
                color: #555;
                margin: 3px 0;
            }

            /* أزرار */
            .btn {
                padding: 5px 10px;
                border: none;
                border-radius: 5px;
                cursor: pointer;
                margin: 2px;
            }

            .btn-edit {
                background: #ffc107;
                color: #000;
            }

            .btn-delete {
                background: #dc3545;
                color: #fff;
            }

            .btn-add {
                background: #28a745;
                color: #fff;
                margin-bottom: 20px;
            }

            /* نموذج الإضافة/التعديل */
            .modal {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                justify-content: center;
                align-items: center;
            }

            .modal-content {
                background: #fff;
                padding: 20px;
                border-radius: 12px;
                width: 90%;
                max-width: 400px;
            }

            .modal-content input,
            .modal-content select {
                width: 100%;
                padding: 8px;
                margin: 5px 0;
            }

            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .close-btn {
                cursor: pointer;
                font-size: 1.2rem;
                font-weight: bold;
            }
        </style>
    </head>

    <body>
        <header class="main-header">
            <div class="container">
                <h1>لوحة البائع</h1>
            </div>
        </header>

        <div class="container">
            <button class="btn btn-add" id="addProductBtn">إضافة منتج جديد</button>
            <div class="products-grid" id="productsGrid">
                <!-- سيتم ملئ المنتجات بواسطة JS -->
            </div>
        </div>

        <!-- نموذج الإضافة/التعديل -->
        <div class="modal" id="productModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTitle">إضافة منتج</h3>
                    <span class="close-btn" id="closeModal">&times;</span>
                </div>
                <input type="hidden" id="productId">
                <input type="text" id="productName" placeholder="اسم المنتج">
                <input type="text" id="productDescription" placeholder="وصف المنتج">
                <input type="number" id="productPrice" placeholder="السعر">
                <input type="number" id="productStock" placeholder="الكمية">
                <input type="text" id="productImage" placeholder="رابط صورة المنتج">
                <select id="productCategory">
                    <option value="">اختر الفئة</option>
                </select>
                <button class="btn btn-add" id="saveProductBtn">حفظ المنتج</button>
            </div>
        </div>

        <script>
            const API_BASE = "http://127.0.0.1:8000/api";
            const accessToken = "PUT_YOUR_ACCESS_TOKEN_HERE"; // ضع هنا الـ access token الخاص بالبائع

            const productsGrid = document.getElementById('productsGrid');
            const productModal = document.getElementById('productModal');
            const addProductBtn = document.getElementById('addProductBtn');
            const closeModal = document.getElementById('closeModal');
            const modalTitle = document.getElementById('modalTitle');
            const saveProductBtn = document.getElementById('saveProductBtn');

            const productId = document.getElementById('productId');
            const productName = document.getElementById('productName');
            const productDescription = document.getElementById('productDescription');
            const productPrice = document.getElementById('productPrice');
            const productStock = document.getElementById('productStock');
            const productImage = document.getElementById('productImage');
            const productCategory = document.getElementById('productCategory');

            addProductBtn.addEventListener('click', () =>
            {
                modalTitle.textContent = "إضافة منتج";
                productModal.style.display = "flex";
                productId.value = "";
                productName.value = "";
                productDescription.value = "";
                productPrice.value = "";
                productStock.value = "";
                productImage.value = "";
                productCategory.value = "";
            });

            closeModal.addEventListener('click', () => { productModal.style.display = "none"; });

            async function fetchProducts()
            {
                try
                {
                    const res = await fetch(`${API_BASE}/seller/products`, {
                        headers: { "Authorization": "Bearer " + accessToken }
                    });
                    const data = await res.json();
                    productsGrid.innerHTML = '';
                    data.data.forEach(p =>
                    {
                        const card = document.createElement('div');
                        card.className = 'product-card';
                        card.innerHTML = `
                        <img src="${API_BASE}/${p.image}" alt="${p.name}" />
                        <h3>${p.name}</h3>
                        <p>${p.description}</p>
                        <p>السعر: ${p.price} USD</p>
                        <p>الكمية: ${p.stock_quantity}</p>
                        <button class="btn btn-edit" onclick="editProduct(${p.id})">تعديل</button>
                        <button class="btn btn-delete" onclick="deleteProduct(${p.id})">حذف</button>
                    `;
                        productsGrid.appendChild(card);
                    });
                } catch (err) { console.error(err); }
            }

            function editProduct(id)
            {
                const product = Array.from(productsGrid.children)
                    .find(card => card.querySelector('button.btn-edit').getAttribute('onclick').includes(id));
                if (!product) return;
                modalTitle.textContent = "تعديل المنتج";
                productModal.style.display = "flex";

                productId.value = id;
                productName.value = product.querySelector('h3').textContent;
                productDescription.value = product.querySelectorAll('p')[0].textContent;
                productPrice.value = parseFloat(product.querySelectorAll('p')[1].textContent.replace('السعر: ', '').replace(' USD', ''));
                productStock.value = parseInt(product.querySelectorAll('p')[2].textContent.replace('الكمية: ', ''));
                productImage.value = product.querySelector('img').getAttribute('src').replace(API_BASE + '/', '');
            }

            async function deleteProduct(id)
            {
                if (!confirm('هل أنت متأكد من حذف هذا المنتج؟')) return;
                try
                {
                    await fetch(`${API_BASE}/seller/products/${id}`, {
                        method: 'DELETE',
                        headers: { "Authorization": "Bearer " + accessToken }
                    });
                    fetchProducts();
                } catch (err) { console.error(err); }
            }

            saveProductBtn.addEventListener('click', async () =>
            {
                const payload = {
                    name: productName.value,
                    description: productDescription.value,
                    price: productPrice.value,
                    stock_quantity: productStock.value,
                    image: productImage.value,
                    category_id: productCategory.value
                };
                const method = productId.value ? 'PUT' : 'POST';
                const url = productId.value ? `${API_BASE}/seller/products/${productId.value}` : `${API_BASE}/seller/products`;

                try
                {
                    await fetch(url, {
                        method,
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": "Bearer " + accessToken
                        },
                        body: JSON.stringify(payload)
                    });
                    productModal.style.display = "none";
                    fetchProducts();
                } catch (err) { console.error(err); }
            });

            async function fetchCategories()
            {
                try
                {
                    const res = await fetch(`${API_BASE}/categories`);
                    const data = await res.json();
                    data.data.forEach(cat =>
                    {
                        const option = document.createElement('option');
                        option.value = cat.id;
                        option.textContent = cat.name;
                        productCategory.appendChild(option);
                    });
                } catch (err) { console.error(err); }
            }

            fetchCategories();
            fetchProducts();
        </script>
    </body>

</html>
